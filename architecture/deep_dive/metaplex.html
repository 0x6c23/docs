<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.13">
<link rel="search" type="application/opensearchdescription+xml" title="Metaplex Docs" href="/opensearch.xml"><title data-react-helmet="true">Metaplex | Metaplex Docs</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://docs.metaplex.com/architecture/deep_dive/metaplex"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Metaplex | Metaplex Docs"><meta data-react-helmet="true" name="description" content="Overview"><meta data-react-helmet="true" property="og:description" content="Overview"><link data-react-helmet="true" rel="icon" href="/img/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://docs.metaplex.com/architecture/deep_dive/metaplex"><link data-react-helmet="true" rel="alternate" href="https://docs.metaplex.com/architecture/deep_dive/metaplex" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://docs.metaplex.com/architecture/deep_dive/metaplex" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://ONUK0F738E-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.93741125.css">
<link rel="preload" href="/assets/js/runtime~main.518a6f02.js" as="script">
<link rel="preload" href="/assets/js/main.b2d8f758.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/meta-white.svg" alt="Metaplex logo" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/img/meta-black.svg" alt="Metaplex logo" class="themedImage_1VuW themedImage--dark_hz6m"></div><b class="navbar__title">Metaplex Docs</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/metaplex-foundation/metaplex/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_71bT toggle_3Zt9 toggleDisabled_3cF-"><div class="toggleTrack_32Fl" role="button" tabindex="-1"><div class="toggleTrackCheck_3lV7"><span class="toggleIcon_O4iE">ðŸŒœ</span></div><div class="toggleTrackX_S2yS"><span class="toggleIcon_O4iE">ðŸŒž</span></div><div class="toggleTrackThumb_xI_Z"></div></div><input type="checkbox" class="toggleScreenReader_28Tw" aria-label="Switch between dark and light mode"></div><div class="searchBox_1Kl_"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_35hR" type="button"></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" href="/">About</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/nft-standard">Token Metadata Standard</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_2fq0" href="/architecture/overview">Architecture</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/architecture/overview">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/architecture/contracts">The Contracts</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/architecture/basic_flow">Basic Single Item Auction End To End</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_2fq0" tabindex="0" href="/architecture/deep_dive/overview">Deep Dive</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/architecture/deep_dive/overview">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/architecture/deep_dive/token_vault">Token Vault</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/architecture/deep_dive/auction">Auction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/architecture/deep_dive/metaplex">Metaplex</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" href="/overviews/metaplex_overview">Overviews</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" href="/create-store/introduction">Create a Store</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" href="/create-candy/introduction">Create a Candy Machine</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" href="/candy-machine-v2/Introduction">Candy Machine v2</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" href="/fair-launch/introduction">Create a Fair Launch</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" href="/airdrops/create-gumdrop">Airdrops</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" href="/sdk/js/getting-started">SDKs</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/community">Community Docs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/stability">Stability</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/security-policy">Security Policy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/contact">Contact Us</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Metaplex</h1></header><h2 class="anchor anchorWithStickyNavbar_31ik" id="overview">Overview<a aria-hidden="true" class="hash-link" href="#overview" title="Direct link to heading">â€‹</a></h2><p>The Metaplex is the contract that knows how the others tie together and understands what an NFT truly is, how to auction it off and how to redeem it for others. It also understands the concept of royalties and how to pay them out. It&#x27;s job is to act is the orchestrator between a Vault full of tokens, an Auction primitive, a bunch of winners, creators, and an auctioneer, and make sure everybody gets what is deserved, whether it be monies or tokens (though in the end they are all tokens).</p><p>It&#x27;s state is reproduced here:</p><div class="codeBlockContainer_K1bP language-rust"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">#[repr(C)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[derive(Clone, BorshSerialize, BorshDeserialize, PartialEq, Debug, Copy)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub enum Key {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Uninitialized,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    OriginalAuthorityLookupV1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BidRedemptionTicketV1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    StoreV1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    WhitelistedCreatorV1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PayoutTicketV1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SafetyDepositValidationTicketV1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AuctionManagerV1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PrizeTrackingTicketV1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[repr(C)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[derive(Clone, BorshSerialize, BorshDeserialize, Debug)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub struct AuctionManager {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub key: Key,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub store: Pubkey,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub authority: Pubkey,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub auction: Pubkey,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub vault: Pubkey,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub accept_payment: Pubkey,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub state: AuctionManagerState,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub settings: AuctionManagerSettings,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /// True if this is only winning configs of one item each, used for optimization in saving.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub straight_shot_optimization: bool,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[repr(C)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[derive(Clone, BorshSerialize, BorshDeserialize, Debug)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub struct AuctionManagerState {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub status: AuctionManagerStatus,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// When all configs are validated the auction is started and auction manager moves to Running</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub winning_config_items_validated: u8,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub winning_config_states: Vec&lt;WinningConfigState&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub participation_state: Option&lt;ParticipationState&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[repr(C)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[derive(Clone, BorshSerialize, BorshDeserialize, Debug)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub struct AuctionManagerSettings {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// The safety deposit box index in the vault containing the winning items, in order of place</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// The same index can appear multiple times if that index contains n tokens for n appearances (this will be checked)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub winning_configs: Vec&lt;WinningConfig&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// The participation config is separated because it is structurally a bit different,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// having different options and also because it has no real &quot;winning place&quot; in the array.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub participation_config: Option&lt;ParticipationConfig&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[repr(C)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[derive(Clone, BorshSerialize, BorshDeserialize, PartialEq, Debug)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub struct ParticipationState {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// We have this variable below to keep track in the case of the participation NFTs, whose</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// income will trickle in over time, how much the artists have in the escrow account and</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// how much would/should be owed to them if they try to claim it relative to the winning bids.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// It&#x27;s  abit tougher than a straightforward bid which has a price attached to it, because</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// there are many bids of differing amounts (in the case of GivenForBidPrice) and they dont all</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// come in at one time, so this little ledger here keeps track.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub collected_to_accept_payment: u64,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// Record of primary sale or not at time of auction creation, set during validation step</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub primary_sale_happened: bool,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub validated: bool,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// An account for printing authorization tokens that are made with the one time use token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// after the auction ends. Provided during validation step.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub printing_authorization_token_account: Option&lt;Pubkey&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[repr(C)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[derive(Clone, BorshSerialize, BorshDeserialize, PartialEq, Debug)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub struct ParticipationConfig {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// Setups:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// 1. Winners get participation + not charged extra</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// 2. Winners dont get participation prize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub winner_constraint: WinningConstraint,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// Setups:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// 1. Non-winners get prize for free</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// 2. Non-winners get prize but pay fixed price</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// 3. Non-winners get prize but pay bid price</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub non_winning_constraint: NonWinningConstraint,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// The safety deposit box index in the vault containing the template for the participation prize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub safety_deposit_box_index: u8,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// Setting this field disconnects the participation prizes price from the bid. Any bid you submit, regardless</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// of amount, charges you the same fixed price.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub fixed_price: Option&lt;u64&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[repr(C)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[derive(Clone, BorshSerialize, BorshDeserialize, PartialEq, Debug)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub enum WinningConstraint {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NoParticipationPrize,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ParticipationPrizeGiven,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[repr(C)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[derive(Clone, BorshSerialize, BorshDeserialize, PartialEq, Debug)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub enum NonWinningConstraint {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NoParticipationPrize,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GivenForFixedPrice,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GivenForBidPrice,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[repr(C)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[derive(Clone, PartialEq, BorshSerialize, BorshDeserialize, Copy, Debug)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub enum WinningConfigType {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /// You may be selling your one-of-a-kind NFT for the first time, but not it&#x27;s accompanying Metadata,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// of which you would like to retain ownership. You get 100% of the payment the first sale, then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// royalties forever after.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ///</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// You may be re-selling something like a Limited/Open Edition print from another auction,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// a master edition record token by itself (Without accompanying metadata/printing ownership), etc.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// This means artists will get royalty fees according to the top level royalty % on the metadata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// split according to their percentages of contribution.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ///</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// No metadata ownership is transferred in this instruction, which means while you may be transferring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// the token for a limited/open edition away, you would still be (nominally) the owner of the limited edition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// metadata, though it confers no rights or privileges of any kind.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TokenOnlyTransfer,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// Means you are auctioning off the master edition record and it&#x27;s metadata ownership as well as the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// token itself. The other person will be able to mint authorization tokens and make changes to the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// artwork.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FullRightsTransfer,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// Means you are using authorization tokens to print off editions during the auction using</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// from a MasterEditionV1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PrintingV1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// Means you are using the MasterEditionV2 to print off editions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PrintingV2,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[repr(C)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[derive(Clone, BorshSerialize, BorshDeserialize, Debug)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub struct WinningConfig {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // For now these are just array-of-array proxies but wanted to make them first class</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // structs in case we want to attach other top level metadata someday.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub items: Vec&lt;WinningConfigItem&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[repr(C)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[derive(Clone, BorshSerialize, BorshDeserialize, Debug)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub struct WinningConfigState {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub items: Vec&lt;WinningConfigStateItem&gt;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// Ticked to true when money is pushed to accept_payment account from auction bidding pot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub money_pushed_to_accept_payment: bool,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[repr(C)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[derive(Clone, BorshSerialize, BorshDeserialize, Copy, Debug)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub struct WinningConfigItem {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub safety_deposit_box_index: u8,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub amount: u8,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub winning_config_type: WinningConfigType,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[repr(C)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[derive(Clone, BorshSerialize, BorshDeserialize, Copy, Debug)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub struct WinningConfigStateItem {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// Record of primary sale or not at time of auction creation, set during validation step</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub primary_sale_happened: bool,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// Ticked to true when a prize is claimed by person who won it</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub claimed: bool,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[repr(C)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[derive(Clone, BorshSerialize, BorshDeserialize, Debug, PartialEq)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub enum AuctionManagerStatus {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Initialized,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Validated,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Running,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Disbursing,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Finished,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[repr(C)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[derive(Clone, BorshSerialize, BorshDeserialize, Copy)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub struct OriginalAuthorityLookup {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub key: Key,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub original_authority: Pubkey,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[repr(C)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[derive(Clone, BorshSerialize, BorshDeserialize, Copy)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub struct BidRedemptionTicket {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub key: Key,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub participation_redeemed: bool,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub items_redeemed: u8,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[repr(C)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[derive(Clone, BorshSerialize, BorshDeserialize, Copy)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub struct PayoutTicket {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub key: Key,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub recipient: Pubkey,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub amount_paid: u64,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[repr(C)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[derive(Clone, BorshSerialize, BorshDeserialize, Copy)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub struct Store {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub key: Key,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub public: bool,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub auction_program: Pubkey,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub token_vault_program: Pubkey,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub token_metadata_program: Pubkey,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub token_program: Pubkey,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[repr(C)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[derive(Clone, BorshSerialize, BorshDeserialize, Copy)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub struct WhitelistedCreator {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub key: Key,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub address: Pubkey,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub activated: bool,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[repr(C)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[derive(Clone, BorshSerialize, BorshDeserialize, Copy)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub struct SafetyDepositValidationTicket {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub key: Key,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub address: Pubkey,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[repr(C)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[derive(Clone, BorshSerialize, BorshDeserialize, Copy, Debug)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub struct PrizeTrackingTicket {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub key: Key,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub metadata: Pubkey,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub supply_snapshot: u64,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub expected_redemptions: u64,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub redemptions: u64,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The instruction set for metaplex can be found here: <a href="https://github.com/metaplex-foundation/metaplex/blob/master/rust/token-vault/program/src/instruction.rs" target="_blank" rel="noopener noreferrer">https://github.com/metaplex-foundation/metaplex/blob/master/rust/metaplex/program/src/instruction.rs</a></p><h2 class="anchor anchorWithStickyNavbar_31ik" id="types">Types<a aria-hidden="true" class="hash-link" href="#types" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_31ik" id="auctionmanager">AuctionManager<a aria-hidden="true" class="hash-link" href="#auctionmanager" title="Direct link to heading">â€‹</a></h3><p>This is the top level struct of the entire contract and serves as a container for &quot;all the things.&quot; When you make auctions on Metaplex, you are actually really making these ultimately. An AuctionManager has a single authority (you, the auctioneer), a store, which is the storefront struct, an Auction from the auction contract, and a Vault from the vault contract. It also has a token account called <code>accept_payment</code> that serves as a central clearing escrow for all tokens that it will collect in the future from the winning bidders and all payments for fixed price participation nfts from all non-winners in the auction.</p><p>It contains embedded within it a separate <code>state</code> and <code>settings</code> struct. It is seeded with the <code>settings</code> on initialization by the caller, while the <code>state</code> is derived from <code>settings</code> on initialization. AuctionManager goes through several states:</p><p><strong>Initialized:</strong> This is the state it begins in. You provide a <strong>Created</strong> auction and a <strong>Combined</strong> vault. You can&#x27;t start the auction yet though because you need to prove to this AuctionManager that the configurations you provided in your settings match the tokens in the vault.</p><p><strong>Validated:</strong> You have now proven that each winning configuration in your settings match the tokens in your vault, and you can start the auction via a proxy call.</p><p><strong>Running:</strong> The underlying Auction is now running.</p><p><strong>Disbursing</strong>: The underlying Auction is over and now the AuctionManager is in the business of disbursing royalties to the auctioneer and creators, prizes and participation NFTs to the winners, and possibly participation NFTs to the non-winners.</p><p><strong>Finished:</strong> All funds and prizes disbursed.</p><p>This state is not currently in use as switching to it requires an iteration over prizes to review all items for claimed-ness and this costs CPU that is too precious during the redemption call OR adding new endpoint that is not guaranteed to be called. We will revisit it later to bring it back during a refactoring, for now it is considered a NOOP state.</p><p>AuctionManagers always have PDAs of seed <code>[&#x27;metaplex&#x27;, metaplex_program_id, auction_id]</code> where metaplex_program_id is the id of the Metaplex contract and <code>auction_id</code> is the address of the Auction being passed to the AuctionManager.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="auctionmanagersettings">AuctionManagerSettings<a aria-hidden="true" class="hash-link" href="#auctionmanagersettings" title="Direct link to heading">â€‹</a></h3><p>AuctionManagerSettings is an embedded struct inside AuctionManager but is deserving of it&#x27;s own section. This struct is actually provided by the user in the <code>init_auction_manager</code> call to parameterize the AuctionManager with who is winning what and whether or not there is a participation NFT. It is fairly straightforward - for each entry in the WinningConfig vec, it stands for a given winning place in the Auction. The 0th entry is the WinningConfig for the 1st place winner. A WinningConfig has many WinningConfigItems. For each WinningConfigItem in the 0th WinningConfig, it is a mapping to a Vault SafetyDepositBox that the 1st place winner gets items from. You can therefore configure quite arbitrary Auctions this way.</p><p>This setup is actually quite redundant and will likely change in the future to a setup where a WinningConfigItem is the top level structure and it simply declares which winners will receive it, because if you wish for multiple winners to receive prints from the same Master Edition, the WinningConfigItem must right now be duplicated across each WinningConfig.</p><p>The Participation Config is optional, but has enums describing how it will behave for winners and for non-winners, whether or not it has a price associated with it, and what safety deposit box contains its printing tokens.</p><p>Notice that AuctionManagerSettings really doesn&#x27;t contain settings about the auction. It really only breaks down how to divvy up the Vault. This is the separation of concerns in action - the Auction is parameterized with auction settings, while the AuctionManager understands how to divvy up rewards to winners and is parameterized that way. The Auction does not understand how to divvy up rewards, and the Metaplex contract does not understand how to do Auctions, only how to read winners off of it.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="auctionmanagerstate">AuctionManagerState<a aria-hidden="true" class="hash-link" href="#auctionmanagerstate" title="Direct link to heading">â€‹</a></h3><p>I consciously made the decision to keep AuctionManagerSettings identical to what you send up when you initialize AuctionManager. However, other things related to WinningConfigs, WinningConfigItems, etc change as the AuctionManager moves through its motions. These changes are recorded in AuctionManagerState, a kind of mirror object that is instantiated during the <code>init_auction_manager</code> action.</p><p>Specifically, for each WinningConfigItem, we need to record at the time of creation whether the primary sale had happened for later royalties measurement (because this could be changed during auction) and we need to record whether or not this particular WinningConfigItem has been claimed by the winner yet. We do similar things for Participation prize in it&#x27;s own config.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="bidredemptionticket">BidRedemptionTicket<a aria-hidden="true" class="hash-link" href="#bidredemptionticket" title="Direct link to heading">â€‹</a></h3><p>This is created once per bid and keeps track of whether a given bidder has redeemed their main bid and their participation NFT. This is how the Metaplex contract guarantees a given bidder gets something in exchange for their BidderMetadata PDA in the Auction contract.</p><p>BidRedemptionTickets always have PDAs of <code>[&#x27;metaplex&#x27;, auction_id, bidder_metadata_key]</code> where the <code>auction_id</code> is the address of the Auction and the <code>bidder_metadata_key</code> is the address of the BidderMetadata PDA that the Auction contract produced.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="payoutticket">PayoutTicket<a aria-hidden="true" class="hash-link" href="#payoutticket" title="Direct link to heading">â€‹</a></h3><p>For each creator, for each metadata(WinningConfigItem), for each winning place(WinningConfig) in an Auction, a PayoutTicket is created to record the sliver of income generated for that creator. There is also one made for the Auctioneer for every such case. And yes, it really is that specific. This means that a given creator may have quite a few PayoutTickets for a single AuctionManager, but each one represents a slightly different royalty payout.</p><p>For instance, 1st place may have three items with 3 unique metadata won while 2nd place may have 4 metadata from 4 items, every item with a single unique creator. The split of funds in the 1st place is going to be 3 ways, while in 2nd place would be 4 ways. Even if 1st and 2nd place bids are the same, we want two records to reflect the royalties paid from 1st and 2nd place, because they would be different numbers in this case, and we want to preserve history.</p><p>PayoutTickets always have PDAs of <code>[&#x27;metaplex&#x27;, auction_manager_id, winning_config_index, winning_config_item_index, creator_index, safety_deposit_key, destination_owner]</code> where <code>auction_manager_id</code> is the address of the AuctionManager account, <code>winning_config_index</code> is the 0-based index of the WinningConfig in the AuctionManager settings you paid out in this ticket, <code>winning_config_item_index</code> is the 0-based index of the WinningConfigItem in that WinningConfig, <code>creator_index</code> is the 0-based creator index in that Metadata&#x27;s creator array that you paid out for that WinningConfigItem (or &#x27;auctioneer&#x27; if paying the auctioneer for this item), <code>safety_deposit_key</code> is the address to the safety deposit box for this item, and <code>destination_owner</code> is the owner of the destination account where the monies are being sent. Yeah, I know, painful.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="store">Store<a aria-hidden="true" class="hash-link" href="#store" title="Direct link to heading">â€‹</a></h3><p>Every person who forks the repository to make their own storefront should have a unique store struct that is seeded by their own administrative wallet. These are created and updated by the idempotent <code>set_store</code> endpoint. Each store can choose to use it&#x27;s own token, token-metadata, token-vault and auction programs if it so chooses, though right now we&#x27;ve got a hard check that the token program is actually the global spl-token program. The store also can be either public or private, which determines whether or not AuctionManagers can sell items that have all non-whitelisted creators on them or not. We take a &quot;bouncer-knows-your-friend-and-lets-you-in&quot; approach to selling items in whitelist-only stores - if an item has at least one <em>verified</em> Whitelisted Creator, then it can be sold.</p><p>Store PDAs are always a PDA seed of <code>[&#x27;metaplex&#x27;, metaplex_program_id, admin_wallet]</code> where <code>metaplex_program_id</code> is the address of the Metaplex contract and <code>admin_wallet</code> is the wallet that is administering this store.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="whitelistedcreator">WhitelistedCreator<a aria-hidden="true" class="hash-link" href="#whitelistedcreator" title="Direct link to heading">â€‹</a></h3><p>A cousin of the simple Creator struct from the Metadata program, this is a foreign key connector between a creator address and a store. It denotes whether or not this creator is currently active in the store and if they are, allows items from them to be sold in it.</p><p>WhitelistedCreator PDAs are always a PDA seed of <code>[&#x27;metaplex&#x27;, metaplex_program_id, store_key, creator_key]</code> where <code>metaplex_program_id</code> is the address of the Metaplex contract, <code>store_key</code> is the address of the storefront, and <code>creator_key</code> is obviously the address of the creator&#x27;s wallet you are whitelisting.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="safetydepositvalidationticket">SafetyDepositValidationTicket<a aria-hidden="true" class="hash-link" href="#safetydepositvalidationticket" title="Direct link to heading">â€‹</a></h3><p>This PDA solely exists to prevent validating a safety deposit box twice, which could present security vulnerabilities. It is created for each safety deposit box when it is presented for validation.</p><p>SafetyDepositValidationTickets are always PDAs with seed of <code>[&#x27;metaplex&#x27;, metaplex_program_id, auction_manager_id, safety_deposit_key]</code>where <code>metaplex_program_id</code> is the address of the Metaplex contract, <code>auction_manager_id</code> is the address of the AuctionManager, and <code>safety_deposit_key</code> is the address of the SafetyDepositBox being validated.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="originalauthoritylookup">OriginalAuthorityLookup<a aria-hidden="true" class="hash-link" href="#originalauthoritylookup" title="Direct link to heading">â€‹</a></h3><p>These are created during FullRightsTransfers. When a FullRightsTransfer is happening, the Metadata <code>updateAuthority</code> is shifted from the Auctioneer to the AuctionManager so that it can grant it in turn to the winner, and this record is created to keep track of who the original <code>updateAuthority</code> was to return it later if the item is not sold. That functionality (returns) is not implemented as of this writing but will be in the near future.</p><p>OriginalAuthorityLookups always have PDAs with seed of <code>[&#x27;metaplex&#x27;, auction_id, metadata_key]</code> where <code>auction_id</code> is the address of the Auction and <code>metadata_key</code> is the address of the actual Metadata struct.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="prizetrackingticket">PrizeTrackingTicket<a aria-hidden="true" class="hash-link" href="#prizetrackingticket" title="Direct link to heading">â€‹</a></h3><p>Created on a distinct WinningConfigItem basis (ie by WinningConfigType AND mint) across all WinningConfigs, one PrizeTrackingTicket is created to keep track of how many expected redemptions there will be across all winners for a given MasterEdition, and what the supply was when the first person hit redeem, to keep track of the relative edition offsets each person should get relative to winner #1, #2, etc. This is used for redeeming PrintingV2 bids, to ensure winner #1 gets edition #1, and so on.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="concepts">Concepts<a aria-hidden="true" class="hash-link" href="#concepts" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_31ik" id="types-of-token-sales">Types of Token Sales<a aria-hidden="true" class="hash-link" href="#types-of-token-sales" title="Direct link to heading">â€‹</a></h3><p>There are five major types of token sales supported by the Metaplex protocol. Four are covered in the WinningConfigType enum, but this is a bit limiting as it is really only considering sales to <em>winners</em>, and leaves out the all-important Participation NFT which is a different kind of sale we will consider separately.</p><p><strong>TokenOnlyTransfer:</strong> Probably the easiest to understand, this is a straight up <code>spl_token::transfer</code> command wrapped in a bunch of Metaplex magic. At the end of the day, the auctioneer still owns the Metadata struct and any other associated PDAs, but someone else now has the physical token in their wallets. These tokens will still show up and work just fine in Phantom and other supported wallet clients because those clients can still look up the Metadata. This is the difference between owning the Metadata and owning the token. For a token that is an Edition, the difference is nominal, as an Edition has zero printing rights and is immutable. However, for a token that is a MasterEdition, the difference is <em>substantial</em>, as the owner of the Metadata can rename it, change its symbol, it&#x27;s URI, and creators array.</p><p>Note that owning the token itself is the <em>only</em> requirement for using the <code>update_primary_sale_happened_via_token</code> endpoint on the token metadata program <em>and</em> for using the <code>mint_new_edition_from_master_edition_via_token</code>.</p><p><strong>FullRightsTransfer:</strong> This is a TokenOnlyTransfer, except in addition, the <code>updateAuthority</code> on the Metadata struct is set to the new owner as well, so they now have all the rights and privileges associated with the original owner, including the right to mint printing tokens. They can even change the name and URI of your token, so be careful!</p><p><strong>PrintingV1:</strong> This token type represents a deprecated logic flow that will be removed in future editions and can only be accessed if using a MasterEditionV1 type of NFT. In this case, the safety deposit box in question does not contain the actual token, but a token from the token&#x27;s Master Edition&#x27;s <code>printing_mint</code>. This printing token gives the bearer the authorization to label any mint they have that has a supply of one and decimals zero as a child Edition of that Master Edition one time. This is how Metaplex used to do a Printing sale. It doesn&#x27;t grant the winning bidder a Limited Edition NFT. It grants them a printing token, they make their own mint/token account combo, and take the printing token to the token metadata contract and label it themselves.</p><p><strong>PrintingV2:</strong> The Auction holds the Master Edition in the safety deposit box and uses it via the special <code>mint_new_edition_from_master_edition_via_vault_proxy</code> call on Token Metadata to mint editions for auction winners. Once all bids have been redeemed, the auction releases the Master Edition from this escrow via the <code>withdraw_master_edition</code> call on Metaplex. This flow makes use of the PrizeTrackingTicket to keep track of the starting supply when the first redemption happens so that as each bidder comes in to redeem, everybody gets the correct offset for their edition relative to the #1 winner.</p><p><strong>Participation NFTs:</strong> Treated just like a PrintingV2, except these are first-come-first-serve as far as edition-numbering goes. This endpoint will also collect payment if the participation config has a fixed price setting or is using the &quot;use last bid&quot; setting to charge the user based on their last bid. Note that charging users for participation NFTs only can happen if they lose. Since the user previously cancelled their bid if they lost, they will net no change or net the difference between their last bid and the fixed price.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="royalties">Royalties<a aria-hidden="true" class="hash-link" href="#royalties" title="Direct link to heading">â€‹</a></h3><p>Metadata come locked and stocked with arrays of creators, each with their own <code>share</code> and all guaranteed to sum to 100. The Metadata itself has a <code>seller_fee_basis_points</code> field that represents the share creators get out of the proceeds in any secondary sale and a <code>primary_sale_happened</code> boolean that distinguishes to the world whether or not this particular Metadata has experienced it&#x27;s first sale or not. With all of this, Metaplex is able to do complete Royalty calculations after an Auction is over. It was mentioned above that on initialization, the Metaplex contract snapshots for each Metadata being sold the <code>primary_sale_happened</code> just in case the boolean is flipped during the auction so that royalties are calculated as-of initiation - this is important to note.</p><p>At the end of the auction, anybody (permissionless) can cycle through each winning bid in the contract and ask the Metaplex contract to use its authority to call the Auction contract and pump the winning bid monies into the <code>accept_payment</code> escrow account via <code>claim_bid</code>. Once all winning bids have been settled into here, royalties are eligible to be paid out. We&#x27;ll cover payouts of fixed price Participation NFTs separately.</p><p>Now, anybody (permissionless) can cycle through each creator PLUS the auctioneer on each item in each winning bid and call <code>empty_payment_account</code> with an Associated Token Account that is owned by that creator or auctioneer and that action will calculate, using the creator&#x27;s share or auctioneer&#x27;s share of that item&#x27;s metadata, and the fractional percentage of that item of the overall winning basket, to payout the creator or auctioneer from the escrow.</p><p>Our front end implementation immediately calls the <code>update_primary_sale_happened</code> endpoint on token metadata for any token once redeemed for users so that if they re-sell, the <code>primary_sale_happened</code> boolean is taken into account in the <code>empty_payment_account</code> logic and only the basis points given in <code>seller_fee_basis_points</code> goes to the creators instead of the whole pie. The remaining part of the pie goes to the auctioneer doing the reselling.</p><p>We don&#x27;t do weighted items in winning baskets right now - if a winning basket has 3 unique metadata in it right now, it is split three ways, even if one of the metadata is disbursing 3 tokens while the other is disbursing 2. This may come in a future version. Once this cycle is complete, the escrow account is usually empty.</p><p>Things get a little complex when participation NFTs come into play. When a participation NFT has a fixed price, it is only paid in the case of non-winners. What they first do is cancel their bid, getting a refund, and then they redeem their participation bid with the <code>redeem_participation_bid</code> endpoint. This charges them the fixed price and dumps those funds into the <code>accept_payment</code> account. At intervals, someone must come and turn the crank to dump the proceeds to the creators of the Participation NFT from the latest redeemers of that NFT because they will only receive proceeds as people come and redeem and pay for them.</p><p>Note because our front end implementation chooses to use SOL instead of a generic SPL token, we use a Wrapped SOL ATA account for creators. They are then forced to use a drop down menu to liquidate and close the Wrapped SOL ATA account when they next login, absorbing the Wrapped SOL back into their normal SOL wallets. If you choose not to use SOL in your implementation, you will not have this difficulty.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="validation">Validation<a aria-hidden="true" class="hash-link" href="#validation" title="Direct link to heading">â€‹</a></h3><p>Just because you provide a vault to an AuctionManager and an AuctionManagerSettings declaring this vault is filled with wonderful prizes <em>does not</em> believe that Metaplex will believe you. For every safety deposit box indexed in a WinningConfigItem, there must be a call to <code>validate_safety_deposit_box</code> after initiation where the safety deposit box is provided for inspection to the Metaplex contract so that it can verify that there are enough tokens, and of the right type, to pay off all winners in the auction.</p><p>Given how irritating this process is, we may in the future merge token-vault with metaplex, or simply copy over the parts of it that are relevant, leaving token-vault out for those interested in experimenting with fractionalization.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="unwon-items">Unwon Items<a aria-hidden="true" class="hash-link" href="#unwon-items" title="Direct link to heading">â€‹</a></h3><p>Any Token Only Transfer item, or MasterEditionV1/MasterEditionV2 stored for a Full Rights Transfer unwon in an Auction can be returned to the Auction Manager by calling the <code>redeem_unused_winning_config_items_as_auctioneer</code> end point. It acts as a proxy, calling the <code>redeem_bid</code> or <code>redeem_full_rights_transfer_bid</code> depending on how it is parameterized, and passing in a winning_index that overrides the actual winning_index that would be detected for the bidder_info key being passed in (which is the auctioneer&#x27;s in this case.) In this way the auctioneer acts not as a winning bidder but as a generic &quot;non-bidder&quot; who empties each prize that has no bidder using the same redemption flow. For MasterEditionV2s stored for PrintingV2 or Participation prizes, these can be withdrawn using <code>withdraw_edition</code>.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/metaplex/docs/tree/main/docs/architecture/deep_dive/metaplex.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/architecture/deep_dive/auction"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« <!-- -->Auction</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/overviews/metaplex_overview"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Why Metaplex?<!-- --> Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#types" class="table-of-contents__link toc-highlight">Types</a><ul><li><a href="#auctionmanager" class="table-of-contents__link toc-highlight">AuctionManager</a></li><li><a href="#auctionmanagersettings" class="table-of-contents__link toc-highlight">AuctionManagerSettings</a></li><li><a href="#auctionmanagerstate" class="table-of-contents__link toc-highlight">AuctionManagerState</a></li><li><a href="#bidredemptionticket" class="table-of-contents__link toc-highlight">BidRedemptionTicket</a></li><li><a href="#payoutticket" class="table-of-contents__link toc-highlight">PayoutTicket</a></li><li><a href="#store" class="table-of-contents__link toc-highlight">Store</a></li><li><a href="#whitelistedcreator" class="table-of-contents__link toc-highlight">WhitelistedCreator</a></li><li><a href="#safetydepositvalidationticket" class="table-of-contents__link toc-highlight">SafetyDepositValidationTicket</a></li><li><a href="#originalauthoritylookup" class="table-of-contents__link toc-highlight">OriginalAuthorityLookup</a></li><li><a href="#prizetrackingticket" class="table-of-contents__link toc-highlight">PrizeTrackingTicket</a></li></ul></li><li><a href="#concepts" class="table-of-contents__link toc-highlight">Concepts</a><ul><li><a href="#types-of-token-sales" class="table-of-contents__link toc-highlight">Types of Token Sales</a></li><li><a href="#royalties" class="table-of-contents__link toc-highlight">Royalties</a></li><li><a href="#validation" class="table-of-contents__link toc-highlight">Validation</a></li><li><a href="#unwon-items" class="table-of-contents__link toc-highlight">Unwon Items</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://discord.gg/RfzFD9g9WE" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/metaplex" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/metaplex-foundation/metaplex" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 Metaplex</div></div></div></footer></div>
<script src="/assets/js/runtime~main.518a6f02.js"></script>
<script src="/assets/js/main.b2d8f758.js"></script>
</body>
</html>